{% extends "base.html" %}

{% block title %}Embeddings Visualization{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-chart-line text-primary"></i> Embeddings Visualization
            </h2>
        </div>
    </div>

    <!-- Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-input" placeholder="Search chunks...">
                                <button class="btn btn-outline-secondary" type="button" id="search-btn">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" id="refresh-btn">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Embeddings Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table"></i> Chunks & Embeddings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="embeddings-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Document</th>
                                    <th>Content Preview</th>
                                    <th>Embedding Dim</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="embeddings-tbody">
                                <!-- Embeddings will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chunk Details Modal -->
<div class="modal fade" id="chunkModal" tabindex="-1" aria-labelledby="chunkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chunkModalLabel">Chunk Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="chunk-content">
                    <!-- Chunk content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="delete-chunk-btn">
                    <i class="fas fa-trash"></i> Delete Chunk
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Wait for jQuery to be loaded
function initEmbeddingsPage() {
    if (typeof jQuery === 'undefined') {
        console.log('jQuery not loaded yet, retrying...');
        setTimeout(initEmbeddingsPage, 100);
        return;
    }

    $(document).ready(function() {
        loadEmbeddings();

        // Refresh button
        $('#refresh-btn').click(function() {
            loadEmbeddings();
        });

        // Search functionality
        $('#search-btn').click(function() {
            const query = $('#search-input').val().trim();
            if (query) {
                searchChunks(query);
            } else {
                loadEmbeddings();
            }
        });

        $('#search-input').keypress(function(e) {
            if (e.which == 13) { // Enter key
                $('#search-btn').click();
            }
        });

        // Delete chunk from modal
        $('#delete-chunk-btn').click(function() {
            const chunkId = $(this).data('chunk-id');
            if (chunkId) {
                deleteChunk(chunkId);
            }
        });
    });
}

// Start initialization
initEmbeddingsPage();

function loadEmbeddings() {
    $.get('/api/embeddings')
        .done(function(data) {
            const tbody = $('#embeddings-tbody');
            tbody.empty();

            if (data.chunks && data.chunks.length > 0) {
                data.chunks.forEach(function(chunk) {
                    const preview = chunk.content ? chunk.content.substring(0, 100) + '...' : 'No content';
                    const row = `
                        <tr>
                            <td>${chunk.id || 'N/A'}</td>
                            <td>${chunk.document_name || 'N/A'}</td>
                            <td>${preview}</td>
                            <td>${chunk.embedding_dim || 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewChunk('${chunk.id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteChunk('${chunk.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="5" class="text-center">No chunks found</td></tr>');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Failed to load embeddings:', error);
            $('#embeddings-tbody').html('<tr><td colspan="5" class="text-center text-danger">Error loading embeddings</td></tr>');
        });
}

function searchChunks(query) {
    $.get(`/api/embeddings/search?q=${encodeURIComponent(query)}`)
        .done(function(data) {
            const tbody = $('#embeddings-tbody');
            tbody.empty();

            if (data.chunks && data.chunks.length > 0) {
                data.chunks.forEach(function(chunk) {
                    const preview = chunk.content ? chunk.content.substring(0, 100) + '...' : 'No content';
                    const row = `
                        <tr>
                            <td>${chunk.id || 'N/A'}</td>
                            <td>${chunk.document_name || 'N/A'}</td>
                            <td>${preview}</td>
                            <td>${chunk.embedding_dim || 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewChunk('${chunk.id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteChunk('${chunk.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="5" class="text-center">No chunks found matching your search</td></tr>');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Failed to search chunks:', error);
            $('#embeddings-tbody').html('<tr><td colspan="5" class="text-center text-danger">Error searching chunks</td></tr>');
        });
}

function viewChunk(chunkId) {
    $.get(`/api/embeddings/chunk/${chunkId}`)
        .done(function(data) {
            $('#chunk-content').html(`
                <h6>Document: ${data.chunk.document_name || 'N/A'}</h6>
                <h6>Chunk ID: ${data.chunk.id || 'N/A'}</h6>
                <hr>
                <p><strong>Content:</strong></p>
                <div class="border p-3 bg-light">
                    ${data.chunk.content || 'No content available'}
                </div>
                <hr>
                <p><strong>Metadata:</strong></p>
                <pre>${JSON.stringify(data.chunk.metadata || {}, null, 2)}</pre>
            `);
            $('#delete-chunk-btn').data('chunk-id', chunkId);
            $('#chunkModal').modal('show');
        })
        .fail(function(xhr, status, error) {
            console.error('Failed to load chunk details:', error);
            alert('Failed to load chunk details');
        });
}

function deleteChunk(chunkId) {
    if (confirm('Are you sure you want to delete this chunk? This action cannot be undone.')) {
        $.ajax({
            url: `/api/embeddings/chunk/${chunkId}`,
            type: 'DELETE',
            success: function(response) {
                alert('Chunk deleted successfully');
                $('#chunkModal').modal('hide');
                loadEmbeddings(); // Refresh the table
            },
            error: function(xhr, status, error) {
                console.error('Failed to delete chunk:', error);
                alert('Failed to delete chunk');
            }
        });
    }
}
</script>

{% endblock %}
