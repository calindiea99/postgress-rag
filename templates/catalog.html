{% extends "base.html" %}

{% block title %}Document Catalog{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-book-open text-primary"></i> Document Catalog
            </h2>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="stats-row">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-file-alt"></i> Total Documents
                    </h5>
                    <h3 id="total-documents">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-puzzle-piece"></i> Total Chunks
                    </h5>
                    <h3 id="total-chunks">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-database"></i> Database Size
                    </h5>
                    <h3 id="db-size">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-clock"></i> Last Updated
                    </h5>
                    <h6 id="last-updated">-</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Documents
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="documents-table">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Upload Date</th>
                                    <th>Chunks</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="documents-tbody">
                                <!-- Documents will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chunks Modal -->
<div class="modal fade" id="chunksModal" tabindex="-1" aria-labelledby="chunksModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chunksModalLabel">Document Chunks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="chunks-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Content Preview</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chunks-tbody">
                            <!-- Chunks will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Metadata Modal -->
<div class="modal fade" id="metadataModal" tabindex="-1" aria-labelledby="metadataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="metadataModalLabel">Document Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="metadata-content">
                    <!-- Metadata will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Wait for jQuery to be loaded
function initCatalogPage() {
    if (typeof jQuery === 'undefined') {
        console.log('jQuery not loaded yet, retrying...');
        setTimeout(initCatalogPage, 100);
        return;
    }

    $(document).ready(function() {
        loadCatalogStats();
        loadDocuments();

        // Refresh button
        $('#refresh-btn').click(function() {
            loadCatalogStats();
            loadDocuments();
        });
    });
}

// Start initialization
initCatalogPage();

function loadCatalogStats() {
    $.get('/api/catalog/stats')
        .done(function(data) {
            $('#total-documents').text(data.total_documents || 0);
            $('#total-chunks').text(data.total_chunks || 0);
            $('#db-size').text(data.db_size || 'N/A');
            $('#last-updated').text(data.last_updated || 'N/A');
        })
        .fail(function(xhr, status, error) {
            console.error('Failed to load catalog stats:', error);
            $('#total-documents').text('Error');
            $('#total-chunks').text('Error');
        });
}

function loadDocuments() {
    $.get('/api/catalog/documents')
        .done(function(data) {
            const tbody = $('#documents-tbody');
            tbody.empty();

            if (data.documents && data.documents.length > 0) {
                data.documents.forEach(function(doc) {
                    const row = `
                        <tr>
                            <td>${doc.filename || 'N/A'}</td>
                            <td>${doc.upload_date || 'N/A'}</td>
                            <td>${doc.chunk_count || 0}</td>
                            <td>${doc.size || 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-info me-1" onclick="viewChunks('${doc.source}')">
                                    <i class="fas fa-eye"></i> View Chunks
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="viewMetadata('${doc.source}', ${JSON.stringify(doc.metadata).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-info-circle"></i> Metadata
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.source}')">
                                    <i class="fas fa-trash"></i> Delete Doc
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="5" class="text-center">No documents found</td></tr>');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Failed to load documents:', error);
            $('#documents-tbody').html('<tr><td colspan="5" class="text-center text-danger">Error loading documents</td></tr>');
        });
}

function viewChunks(filename) {
    $.get(`/api/catalog/document/${encodeURIComponent(filename)}/chunks`)
        .done(function(data) {
            const tbody = $('#chunks-tbody');
            tbody.empty();

            if (data.chunks && data.chunks.length > 0) {
                data.chunks.forEach(function(chunk) {
                    const preview = chunk.content ? chunk.content.substring(0, 100) + '...' : 'No content';
                    const row = `
                        <tr>
                            <td>${chunk.id || 'N/A'}</td>
                            <td>${preview}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteChunk('${chunk.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="3" class="text-center">No chunks found</td></tr>');
            }

            $('#chunksModalLabel').text(`Chunks for ${filename}`);
            $('#chunksModal').modal('show');
        })
        .fail(function(xhr, status, error) {
            console.error('Failed to load chunks:', error);
            alert('Failed to load chunks for this document');
        });
}

function deleteChunk(chunkId) {
    if (confirm('Are you sure you want to delete this chunk?')) {
        $.ajax({
            url: `/api/catalog/chunk/${chunkId}`,
            type: 'DELETE',
            success: function(response) {
                alert('Chunk deleted successfully');
                $('#chunksModal').modal('hide');
                loadCatalogStats(); // Refresh stats
                loadDocuments(); // Refresh documents
            },
            error: function(xhr, status, error) {
                console.error('Failed to delete chunk:', error);
                alert('Failed to delete chunk');
            }
        });
    }
}

function viewMetadata(source, metadata) {
    $('#metadata-content').empty();
    
    if (metadata && Object.keys(metadata).length > 0) {
        const metadataHtml = `
            <div class="row">
                <div class="col-12">
                    <h6><strong>Source:</strong> ${source}</h6>
                    <hr>
                    <h6>Metadata:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        let tbodyContent = '';
        for (const [key, value] of Object.entries(metadata)) {
            const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : value;
            tbodyContent += `
                <tr>
                    <td><strong>${key}</strong></td>
                    <td><code>${displayValue}</code></td>
                </tr>
            `;
        }
        
        const finalHtml = metadataHtml + tbodyContent + `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        $('#metadata-content').html(finalHtml);
    } else {
        $('#metadata-content').html('<p class="text-muted">No metadata available for this document.</p>');
    }
    
    $('#metadataModalLabel').text(`Metadata for ${source.split('/').pop()}`);
    $('#metadataModal').modal('show');
}

function deleteDocument(source) {
    const filename = source.split('/').pop();
    if (confirm(`Are you sure you want to delete the entire document "${filename}"?\n\nThis will delete all ${filename} chunks and cannot be undone.`)) {
        $.ajax({
            url: `/api/catalog/document/${encodeURIComponent(source)}`,
            type: 'DELETE',
            success: function(response) {
                alert(`Document "${filename}" deleted successfully`);
                loadCatalogStats(); // Refresh stats
                loadDocuments(); // Refresh documents
            },
            error: function(xhr, status, error) {
                console.error('Failed to delete document:', error);
                alert('Failed to delete document');
            }
        });
    }
}
</script>

{% endblock %}
