{% extends "base.html" %}

{% block title %}Job Status - Text Ingestion Interface{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-tasks"></i> Job Status</h5>
                <span class="badge bg-{{ 'primary' if job.status == 'running' else 'success' if job.status == 'completed' else 'danger' if job.status == 'failed' else 'secondary' }} fs-6">
                    {{ job.status.title() }}
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Job Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Job ID:</strong></td>
                                <td><code>{{ job.id }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Created:</strong></td>
                                <td>{{ job.created_at[:19] }}</td>
                            </tr>
                            <tr>
                                <td><strong>Collection:</strong></td>
                                <td>{{ job.config.collection_name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Model:</strong></td>
                                <td>{{ job.config.embedding_model }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Progress</h6>
                        {% if job.status == 'running' %}
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: {{ job.progress }}%" id="jobProgress">
                                {{ job.progress }}%
                            </div>
                        </div>
                        {% elif job.status == 'completed' %}
                        <div class="progress mb-3">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%">
                                100% Complete
                            </div>
                        </div>
                        {% endif %}

                        <div class="alert alert-{{ 'info' if job.status == 'running' else 'success' if job.status == 'completed' else 'danger' }}">
                            <strong>Status:</strong> {{ job.message }}
                        </div>

                        {% if job.error %}
                        <div class="alert alert-danger">
                            <strong>Error:</strong> {{ job.error }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if job.results %}
                <div class="mt-4">
                    <h6>Results</h6>
                    <div class="row">
                        {% for key, value in job.results.items() %}
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">{{ value }}</h5>
                                    <p class="card-text text-muted">{{ key.replace('_', ' ').title() }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="mt-4">
                    <a href="{{ url_for('jobs') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Back to Jobs
                    </a>
                    {% if job.status == 'running' %}
                    <button class="btn btn-outline-danger ms-2" onclick="cancelJob()">
                        <i class="fas fa-stop"></i> Cancel Job
                    </button>
                    {% endif %}
                    {% if job.status == 'completed' %}
                    <button class="btn btn-outline-success ms-2" onclick="location.reload()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if job.status == 'running' %}
<script>
// Auto-refresh for running jobs
function updateJobStatus() {
    fetch('/api/job/{{ job.id }}/status')
        .then(response => response.json())
        .then(data => {
            // Update progress bar
            const progressBar = document.getElementById('jobProgress');
            if (progressBar && data.progress !== undefined) {
                progressBar.style.width = data.progress + '%';
                progressBar.textContent = data.progress + '%';
            }

            // Update status message
            const statusAlert = document.querySelector('.alert');
            if (statusAlert && data.message) {
                statusAlert.innerHTML = `<strong>Status:</strong> ${data.message}`;
            }

            // Reload page if job completed or failed
            if (data.status === 'completed' || data.status === 'failed') {
                setTimeout(() => location.reload(), 2000);
            }
        })
        .catch(error => console.error('Error updating job status:', error));
}

function cancelJob() {
    if (confirm('Are you sure you want to cancel this job?')) {
        fetch('/api/job/{{ job.id }}/cancel', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Job cancelled successfully');
                    location.reload();
                } else {
                    alert('Failed to cancel job: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error cancelling job: ' + error);
            });
    }
}

setInterval(updateJobStatus, 3000);
</script>
{% else %}
<script>
function cancelJob() {
    alert('Job is not running');
}
</script>
{% endif %}
{% endblock %}
